{% extends "membership/base.html" %}
{% load staticfiles %}
{% load bootstrap4 %}
{% load util_tags %}
{% load static %}


{% block extra_css %}
  <link href="{% static 'dj/css/datatables.min.css' %}" rel="stylesheet">
  <link href="{% static 'dj/css/bootstrap4-toggle.css' %}" rel="stylesheet">
  <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
  <style>

    .event-listing:hover {
      color: #D60B30
    }

    .event-listing:hover span {
      color: #D60B30;
      transition-duration: .2s;
      transition-timing-function: ease-in
    }

    .event-listing span {
      display: block;
    }

    .event-listing .event-heading {
      font-size: 18px;
      font-weight: 700;
      color: #031E41
    }

    .event-listing .event-date,
    .event-listing .event-info,
    .event-listing .event-location {
      font-size: 14px;
      color: #979797
    }

    .bottom-bordered {
      border-bottom: 1px solid black;
      padding-bottom: 10px;
      margin-bottom: 10px;
    }

    .bottom-bordered:last-child {
      border-bottom: none;
    }


    .event-title {
      font-size: large;
      font-weight: bold;
    }

    .event-date {
      display: inline-flex;
      font-size: medium;
      padding-top: 0.5rem !important;
      padding-bottom: 0.5rem !important;
    }

    .pagination {
      display: inline-flex;
    }
  </style>

{% endblock %}

{% block breadcrumb_items %}
  <li class="breadcrumb-item active" aria-current="page">Events</li>
{% endblock %}

{% block content %}
  <div class="card">
    <div class="card-header">
      <h4 class="mb-0">Event List</h4>
      <div class="row mt-3">
        <div class="col-md-3 text-right">
          From Date :
        </div>
        <div class="col-md-3 text-left">
          <div class="input-group">
            <input type="text"
                   placeholder="From date"
                   title="" required=""
                   id="from_date"/>
            <div class="input-group-append">
              <span class="input-group-text"><span class="fa fa-calendar"></span></span>
            </div>
          </div>
        </div>
        <div class="col-md-3 text-right">
          To Date :
        </div>
        <div class="col-md-3 text-left">
          <div class="input-group">
            <input type="text"
                   placeholder="To date"
                   title="" required=""
                   id="to_date"/>
            <div class="input-group-append">
              <span class="input-group-text"><span class="fa fa-calendar"></span></span>
            </div>
          </div>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-12 text-center">
          <input type="button" class="btn btn-large btn-info" value="Search" id="search_date_btn"/>
        </div>
      </div>
      <br>

    </div>
    <div class="card-body p-0">
      <div class="container">
        <div class="row mt-3">
          <div class="col-md-12 text-right">
            <input id="toggle_map" type="checkbox" checked data-toggle="toggle">
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-6" id="events_container">
            <input type="text" class="form-control" id="search_input" placeholder="Search..."/>
            <div class="row" id="event_table"></div>
          </div>
          <div class="col-md-6" id="events_map">
            <div id="map" style="height: 100%;width: 100%;"></div>
          </div>
        </div>
        <div class="paging-container" id="table_paging"></div>
      </div>
    </div>
  </div>
{% endblock content %}
{% block extra_js %}
  <script src="{% static 'dj/js/datatables.js' %}"></script>
  <script src="{% static 'dj/js/moment.js' %}"></script>
  <script src="{% static 'dj/js/utils.js' %}"></script>
  <script src="{% static 'dj/js/pagination.js' %}"></script>
  <script src="{% static 'dj/js/bootstrap4-toggle.min.js' %}"></script>
  <script src="{% static 'dj/js/tempusdominus-bootstrap-4.min.js' %}"></script>
  <script src="https://openlayers.org/en/v4.6.5/build/ol.js" type="text/javascript"></script>

  <script type="text/javascript">
      function showEvents(events, page_size = 1, page_index = 1) {
          // Fill event page
          let start = page_size * (page_index - 1);
          let end = start + page_size;
          $('#event_table').empty();
          $(events).each(function (index) {
              if (index >= start && index < end) {
                  let start_date = moment(this["start_date"]).format("dddd, MMMM Do YYYY");
                  let end_date = moment(this["end_date"]).format("dddd, MMMM Do YYYY");
                  // Add event div
                  $('#event_table').append("<div class='col-md-12 eventCell event-listing eventRow bottom-bordered mt-3'>");
                  let eventDiv = $('.eventCell:last');
                  // Add event name
                  eventDiv.append("<div class='row'><div class='col-md-12 eventTitle'>"
                      + this["name"] + "</div></div>");
                  // Add event start/end date
                  eventDiv.append("<div class='row'><div class='col-md-12 event-date'><span id='fromDate'>"
                      + start_date + '</span>&nbsp-&nbsp<span id=\'toDate\'>'
                      + end_date + "</span></div></div>");
                  // Add event location
                  eventDiv.append("<div class='row'><div class='col-md-12 eventLocation'>"
                      + this["location"] + "</div></div>");
                  $('.eventRow:last').append("</div>");
              }
          })
      }

      function getEvents(params) {
          let eventUrl = "{% url 'membership_rest_api:event-list' 'v1' %}";
          return $.get(eventUrl, params);
      }

      function initPagination(events=null) {
          let pagination;
          if (events != null) {
              pagination = new Pagination('#table_paging', {
                  itemsCount: events.length,
                  currentPage: 1,
                  pageRange: [1, 10, 20, 30, -1],
                  pageSize: 10,
                  localEvents: events,
                  onGetEvents: function () {
                      return Pagination.localEvents;
                  },
                  onPageChange: function (paging) {
                      showEvents(events, paging.pageSize, paging.currentPage);
                  },
                  onPageSizeChange: function (paging) {
                      paging.currentPage = 1;
                      showEvents(events, paging.pageSize, paging.currentPage);
                  }
              });
          }
          return pagination;
      }
var map;
      $(document).ready(function () {


var mapLat = -33.829357;
var mapLng = 150.961761;
var mapDefaultZoom = 10;
function initialize_map() {
map = new ol.Map({
target: "map",
layers: [
new ol.layer.Tile({
source: new ol.source.OSM({
url: "https://a.tile.openstreetmap.org/{z}/{x}/{y}.png"
})
})
],
view: new ol.View({
center: ol.proj.fromLonLat([mapLng, mapLat]),
zoom: mapDefaultZoom
})
});
}
function add_map_point(lat, lng) {
var vectorLayer = new ol.layer.Vector({
source:new ol.source.Vector({
features: [new ol.Feature({
geometry: new ol.geom.Point(ol.proj.transform([parseFloat(lng), parseFloat(lat)], 'EPSG:4326', 'EPSG:3857')),
})]
}),
style: new ol.style.Style({
image: new ol.style.Icon({
anchor: [0.5, 0.5],
anchorXUnits: "fraction",
anchorYUnits: "fraction",
src: "https://upload.wikimedia.org/wikipedia/commons/e/ec/RedDot.svg"
})
})
});
map.addLayer(vectorLayer);
}
initialize_map();


debugger;

          dateTimePickerWidget('from_date', {format: 'YYYY-MM-DD'});
          dateTimePickerWidget('to_date', {format: 'YYYY-MM-DD'});

          let events = [];

          getEvents({'page_size': '0'})
              .done(function (data) {
                  initPagination(data.results);
                  events=data.results;
                  let lat=0;
                  let long=0;
                  $(events).each(function(){
                      lat += parseFloat(this['map_latitude']);
                      long += parseFloat(this['map_longitude']);
                    add_map_point(this['map_latitude'], this['map_longitude']);

                  })
                  debugger;
                  lat = lat/events.length;
                    long = long/events.length;
                    map.getView().setCenter(ol.proj.transform([long, lat], 'EPSG:4326', 'EPSG:3857'))
                    //map.getView().setCenter(lat,long);
              });



          $('#toggle_map').change(function () {
              let mapState = ($(this).prop('checked'))
              let eventsContainer = $('#events_container');
              let eventRows = $('.eventRow');
              if (mapState === true) {
                  eventsContainer.removeClass('col-md-12');
                  eventsContainer.addClass('col-md-6');
                  eventRows.removeClass('col-md-6');
                  eventRows.addClass('col-md-12');
                  $('#events_map').slideDown();
              } else {
                  $('#events_map').slideUp(function () {
                          eventsContainer.removeClass('col-md-6');
                          eventsContainer.addClass('col-md-12');
                          eventRows.removeClass('col-md-12');
                          eventRows.addClass('col-md-6');
                      }
                  );
              }
          });

          // On Search event by name
          let previousTimeout = undefined;
          $("#search_input").on("keyup paste", function () {
              // Debounce search request
              if (previousTimeout) {
                  clearTimeout(previousTimeout);
              }
              previousTimeout = setTimeout(function () {
                  const searchValue = $("#search_input").val();
                  getEvents({'name': searchValue})
                      .done(function (data) {
                          initPagination(data.results);
                      })
              }, 1000);
          });

          // On Search event by from/to date
          $("#search_date_btn").on("click", function () {
              const fromDate = $("#from_date").val();
              const toDate = $("#to_date").val();
              getEvents({'start_date_min': fromDate, 'end_date_max': toDate})
                  .done(function (data) {
                      initPagination(data.results);
                  });

          });
      });

  </script>

{% endblock extra_js %}